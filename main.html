<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="./css/style.css" type="text/css" media="screen">
    <link rel="stylesheet" href="./css/jquery.slotmachine.css" type="text/css" media="screen">
    <link href="https://cdn.bootcss.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="./js/slotmachine.js"></script>
    <script src="./js/jquery.slotmachine.js"></script>
    <script src="./js/highlight.min.js"></script>
    <script src="./js/javascript.min.js"></script>
    <script type="text/javascript" src="./js/nebPay.js"></script>
    <script defer="" src="./js/all.js"></script>
</head>

  <body>    
    <title>摇摇乐</title>
    <div id="casino" style="padding-top:50px;">
      <div class="content">
        <h1>开心摇摇乐</h1>

        <div>
          <div id="casino1" class="slotMachine" style="margin-left: -65px;">
            <div class="slot slot1"></div>
            <div class="slot slot2"></div>
            <div class="slot slot3"></div>
            <div class="slot slot4"></div>
            <div class="slot slot5"></div>
            <div class="slot slot6"></div>
          </div>

          <div id="casino2" class="slotMachine">
            <div class="slot slot1"></div>
            <div class="slot slot2"></div>
            <div class="slot slot3"></div>
            <div class="slot slot4"></div>
            <div class="slot slot5"></div>
            <div class="slot slot6"></div>
          </div>

          <div id="casino3" class="slotMachine">
            <div class="slot slot1"></div>
            <div class="slot slot2"></div>
            <div class="slot slot3"></div>
            <div class="slot slot4"></div>
            <div class="slot slot5"></div>
            <div class="slot slot6"></div>
          </div>

          <div class="btn-group btn-group-justified" role="group">
            <button id="casinoShuffle" type="button" class="btn btn-primary btn-lg">摇一摇</button>
          </div>
          <div>
            <p id="spinResult"></p>
          </div>
        </div>
      </div>

     
      <div class="modal fade" id="prizeModal" tabindex="-1" role="dialog" aria-labelledby="prizeModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="prizeModalLabel">You win <spin id="winPrize"></spin> nas!</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              It will send to your account by the smart contract. If not, please contact harryge@qq.com.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script id="codeScript5">
      const btnShuffle = document.querySelector('#casinoShuffle');
      const btnStop = document.querySelector('#casinoStop');
      const casino1 = document.querySelector('#casino1');
      const casino2 = document.querySelector('#casino2');
      const casino3 = document.querySelector('#casino3');
      const mCasino1 = new SlotMachine(casino1, {
        active: 0,
        delay: 500
      });
      const mCasino2 = new SlotMachine(casino2, {
        active: 1,
        delay: 500
      });
      const mCasino3 = new SlotMachine(casino3, {
        active: 2,
        delay: 500
      });
      btnShuffle.addEventListener('click', () => {
        onPayClick();
        mCasino1.shuffle(99999);
        mCasino2.shuffle(99999);
        mCasino3.shuffle(99999);
      });

      var NebPay = require("nebpay");
      var nebPay = new NebPay();
      var serialNumber;
      var intervalQuery;
      //var callbackUrl = NebPay.config.mainnetUrl;
      var callbackUrl = NebPay.config.testnetUrl;
      var toAddr = "n21msTLFKy9uFdnvTQAwUZJjg6VdwKJM4Qz";
      var options = {
          goods: {
              name: "Lucky 7 Slot Machine ",
              desc: "Win money if the 3 slots are same"
          },
          callback:callbackUrl
      };
      function onPayClick() {
          serialNumber = nebPay.call(toAddr, 0.001, "spin", "[]", options);
          intervalQuery = setInterval(function() {
              funcIntervalQuery();
          }, 10000);
      }
      function funcIntervalQuery() {   
          nebPay.queryPayInfo(serialNumber, options)
              .then(function (resp) {
                  console.log("tx result: " + resp);
                  var respObject = JSON.parse(resp);
                  console.log(respObject);
                  if(respObject.data.execute_result) {
                    var execRes = JSON.parse(respObject.data.execute_result);
                    var prize = execRes.prize;
                    var slots = execRes.slots;
                    console.log("Got res: ", execRes);
                    if(respObject.code === 0 && slots){
                      clearInterval(intervalQuery);
                      stopAll(slots);
                      if(prize > 0) {
                        document.getElementById("winPrize").innerHTML = prize;
                        $('#prizeModal').modal('show');
                      }
                    }       
                  }
              })
              .catch(function (err) {
                  console.log(err);
              });
      }
      function stopAll(slots) {
        mCasino1.nextActive = slots[0];
        mCasino1.stop();
        mCasino2.nextActive = slots[1];
        mCasino2.stop();
        mCasino3.nextActive = slots[2];
        mCasino3.stop();
      }
    </script>
</body>
</html>